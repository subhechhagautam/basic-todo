<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="To-do List">
    <title>Basic To-do List</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>To-do List</h1>
        </header>

        <main>
            <section class="add-task-section">
                <div class="add-task">
                    <input type="text" id="taskInput" placeholder="Enter a new task..." maxlength="200"
                        aria-label="New task title">
                    <button onclick="addTask()" class="btn-primary">Add Task</button>
                </div>
                <div id="errorMessage" class="error-message"></div>
            </section>

            <section class="tasks-section">
                <div class="task-stats">
                    <span id="taskCount">0 tasks</span>
                    <span id="completedCount">0 completed</span>
                </div>

                <div id="taskList" class="task-list">
                    <div class="loading">Loading tasks...</div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api/tasks';


        window.onload = function () {
            loadTasks();
        };


        async function loadTasks() {
            try {
                const response = await fetch(API_URL);
                const tasks = await response.json();

                const taskList = document.getElementById("taskList");
                taskList.innerHTML = '';

                if (tasks.length === 0) {
                    taskList.innerHTML = '<div class="empty-state"><h3>No tasks yet!</h3><p>Add your first task above</p></div>';
                } else {
                    tasks.forEach(task => {
                        displayTask(task);
                    });
                }
                updateCount();
            } catch (error) {
                console.error('Error loading tasks:', error);
                showError('Failed to load tasks. Make sure the backend is running.');
            }
        }

        // Add new task
        async function addTask() {
            let input = document.getElementById("taskInput");
            let text = input.value.trim();

            if (text === "") {
                showError('Please enter a task');
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/api/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ task_name: text }) // <-- match backend
                });

                if (!response.ok) {
                    throw new Error('Failed to add task');
                }

                input.value = "";
                hideError();
                loadTasks(); // Reload all tasks
            } catch (error) {
                console.error('Error adding task:', error);
                showError('Failed to add task. Please try again.');
            }
        }

        // Display a task in the list
        function displayTask(task) {
            let taskList = document.getElementById("taskList");
            let div = document.createElement("div");
            div.className = "task-item";
            div.dataset.id = task.task_id;

            div.innerHTML = `
        <span class="task-title">${escapeHtml(task.task)}</span>
        <div class="task-actions">
            <button class="btn-small btn-delete" onclick="deleteTask(${task.task_id})">Delete</button>
        </div>
    `;
            taskList.appendChild(div);
        }

        // Toggle task completion
        async function toggleTask(id, completed) {
            try {
                // First get the current task data
                const getResponse = await fetch(`${API_URL}/${id}`);
                const task = await getResponse.json();

                // Update with new completion status
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: task.title,
                        description: task.description,
                        completed: completed
                    })
                });

                if (response.ok) {
                    loadTasks(); // Reload to update UI
                }
            } catch (error) {
                console.error('Error updating task:', error);
                showError('Failed to update task');
            }
        }

        // Delete task
        async function deleteTask(id) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }
            try {
                const response = await fetch(`http://localhost:5000/api/tasks/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    const taskElement = document.querySelector(`[data-id="${id}"]`);
                    if (taskElement) {
                        taskElement.remove();
                    }
                    updateCount();
                } else {
                    throw new Error('Failed to delete task');
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                showError('Failed to delete task');
            }
        }

        // Update task count
        function updateCount() {
            let total = document.querySelectorAll("#taskList .task-item").length;
            let completed = document.querySelectorAll("#taskList .task-item.completed").length;
            document.getElementById("taskCount").innerText = `${total} task${total !== 1 ? 's' : ''}`;
            document.getElementById("completedCount").innerText = `${completed} completed`;
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById("errorMessage");
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => hideError(), 5000); // Auto-hide after 5 seconds
        }

        // Hide error message
        function hideError() {
            const errorDiv = document.getElementById("errorMessage");
            errorDiv.classList.remove('show');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Allow Enter key to add task
        document.addEventListener('DOMContentLoaded', function () {
            const input = document.getElementById('taskInput');
            if (input) {
                input.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        addTask();
                    }
                });
            }
        });
    </script>

</body>

</html>